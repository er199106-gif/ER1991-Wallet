<!-- PART 1: START -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ER1991 Wallet | Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±Ø§Øª</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Firebase (Ù„Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        :root {
            --primary-navy: #0f172a;
            --primary-light: #1e293b;
            --accent-emerald: #10b981;
            --accent-emerald-hover: #059669;
            --accent-emerald-light: #d1fae5;
            --text-dark: #334155;
            --text-light: #94a3b8;
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --border-color: #e2e8f0;
            --danger: #ef4444;
            --danger-light: #fee2e2;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --info: #3b82f6;
            --info-light: #dbeafe;
            --radius-sm: 0.375rem;
            --radius-md: 0.75rem;
            --radius-lg: 1rem;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .dark-mode {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --text-dark: #f8fafc;
            --text-light: #cbd5e1;
            --border-color: #334155;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        
        body {
            font-family: 'Tajawal', 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-dark);
            transition: all 0.3s;
            min-height: 100vh;
        }

        /* Splash Screen */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--primary-navy) 0%, var(--primary-light) 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 10000; color: white;
        }
        
        .logo-area { font-size: 2.5rem; font-weight: 800; margin-bottom: 1rem; }
        .logo-area span { color: var(--accent-emerald); }
        
        .splash-loading { width: 200px; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; overflow: hidden; margin-top: 2rem; }
        .splash-loading-bar { height: 100%; background: var(--accent-emerald); width: 0%; transition: width 0.3s; }

        /* Auth Screen */
        #auth-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-body); z-index: 900;
            display: flex; align-items: center; justify-content: center; padding: 1rem;
        }
        
        .auth-card { width: 100%; max-width: 420px; background: var(--bg-card); padding: 2rem; border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); }
        .auth-logo { text-align: center; margin-bottom: 2rem; }
        .auth-logo h2 { font-size: 1.75rem; color: var(--primary-navy); }
        .auth-logo h2 span { color: var(--accent-emerald); }

        /* Layout */
        #app-screen { display: grid; grid-template-columns: 280px 1fr; min-height: 100vh; }
        
        aside {
            background: var(--primary-navy); color: white; padding: 1.5rem;
            display: flex; flex-direction: column; position: fixed;
            height: 100vh; width: 280px; overflow-y: auto; z-index: 100;
        }
        
        .nav-brand { font-size: 1.5rem; font-weight: 800; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .nav-brand span { color: var(--accent-emerald); }
        
        .nav-section { font-size: 0.7rem; text-transform: uppercase; color: #64748b; margin: 1.5rem 0 0.5rem; }
        .nav-item { padding: 0.9rem 1rem; margin-bottom: 0.5rem; border-radius: var(--radius-md); cursor: pointer; display: flex; align-items: center; gap: 0.75rem; color: #94a3b8; transition: all 0.2s; }
        .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.1); color: white; }
        
        .user-mini-profile { margin-top: auto; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1); }
        
        main { margin-right: 280px; padding: 2rem; min-height: 100vh; }
        
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); }

        /* Components */
        .btn {
            padding: 0.6rem 1.2rem; border-radius: var(--radius-md); border: none;
            cursor: pointer; font-weight: 600; font-family: inherit;
            transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.5rem;
        }
        .btn:hover { transform: translateY(-1px); box-shadow: var(--shadow); }
        .btn-primary { background: var(--primary-navy); color: white; }
        .btn-accent { background: var(--accent-emerald); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--border-color); color: var(--text-dark); }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.85rem; }
        
        .fab {
            position: fixed; bottom: 2rem; left: 2rem; width: 60px; height: 60px;
            border-radius: 50%; background: var(--accent-emerald); color: white;
            border: none; cursor: pointer; font-size: 1.5rem; box-shadow: var(--shadow-lg);
            z-index: 100; display: flex; align-items: center; justify-content: center;
            transition: all 0.3s;
        }
        .fab:hover { transform: scale(1.1) rotate(90deg); }
        
        .card {
            background: var(--bg-card); border-radius: var(--radius-lg);
            padding: 1.5rem; box-shadow: var(--shadow); border: 1px solid var(--border-color);
        }
        
        .input-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.3rem; font-size: 0.9rem; color: var(--text-light); font-weight: 500; }
        input, select, textarea {
            width: 100%; padding: 0.7rem; border-radius: var(--radius-md);
            border: 1px solid var(--border-color); background: var(--bg-card);
            color: var(--text-dark); font-family: inherit;
        }
        input:focus, select:focus { border-color: var(--accent-emerald); outline: none; }
        
        .content-tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 2px solid var(--border-color); overflow-x: auto; }
        .content-tab { padding: 0.75rem 1.25rem; cursor: pointer; color: var(--text-light); white-space: nowrap; border-bottom: 2px solid transparent; margin-bottom: -2px; }
        .content-tab.active-tab { border-bottom-color: var(--accent-emerald); color: var(--accent-emerald); font-weight: 700; }
        
        .table-container { overflow-x: auto; border-radius: var(--radius-md); border: 1px solid var(--border-color); }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { text-align: right; padding: 0.875rem 1rem; border-bottom: 1px solid var(--border-color); }
        th { background: var(--bg-body); color: var(--text-light); font-size: 0.8rem; font-weight: 600; }
        tr:hover td { background: var(--bg-body); }
        
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .status-buy { background: var(--accent-emerald-light); color: var(--accent-emerald); }
        .status-sell { background: var(--danger-light); color: var(--danger); }
        .status-income { background: var(--accent-emerald-light); color: var(--accent-emerald); }
        .status-expense { background: var(--danger-light); color: var(--danger); }
        
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .kpi-card { text-align: center; padding: 1.5rem; border-radius: var(--radius-lg); background: var(--bg-card); border: 1px solid var(--border-color); }
        .kpi-value { font-size: 1.75rem; font-weight: 800; margin: 0.5rem 0; font-family: 'Inter', sans-serif; }
        
        .dashboard-grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 1.5rem; }
        .dashboard-card { background: var(--bg-card); border-radius: var(--radius-lg); padding: 1.5rem; box-shadow: var(--shadow); border: 1px solid var(--border-color); }
        .col-12 { grid-column: span 12; }
        .col-6 { grid-column: span 6; }
        .col-4 { grid-column: span 4; }
        
        @media (max-width: 1024px) {
            #app-screen { grid-template-columns: 1fr; }
            aside { transform: translateX(100%); transition: transform 0.3s; }
            aside.open { transform: translateX(0); }
            main { margin-right: 0; }
            .col-6, .col-4 { grid-column: span 12; }
        }
        
        .hidden { display: none !important; }
        .text-emerald { color: var(--accent-emerald); }
        .text-danger { color: var(--danger); }
        .text-light { color: var(--text-light); }
        
        #toast-container { position: fixed; bottom: 20px; left: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 0.5rem; }
        .toast { background: var(--primary-navy); color: white; padding: 1rem 1.5rem; border-radius: var(--radius-md); box-shadow: var(--shadow-lg); animation: slideIn 0.3s ease-out; display: flex; align-items: center; gap: 10px; }
        @keyframes slideIn { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        .app-footer { text-align: center; padding: 2rem; color: var(--text-light); font-size: 0.875rem; border-top: 1px solid var(--border-color); margin-top: 2rem; }
    </style>
</head>
<body>
    <!-- Splash Screen -->
    <div id="splash-screen">
        <div class="logo-area">ER1991 <span>Wallet</span></div>
        <div class="text-emerald"><i class="fas fa-circle-notch fa-spin fa-2x"></i></div>
        <p class="text-sm mt-4" style="opacity: 0.7">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ÙØ¸Ø©...</p>
        <div class="splash-loading"><div class="splash-loading-bar" id="loading-bar"></div></div>
        <p class="text-xs mt-4" style="opacity: 0.5">Â© 2024 ER1991. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.</p>
    </div>

    <!-- Auth Screen -->
    <div id="auth-screen" class="hidden">
        <div class="auth-card">
            <div class="auth-logo">
                <h2>ER1991 <span>Wallet</span></h2>
                <p class="text-light">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„</p>
            </div>
            <form id="login-form">
                <div class="input-group">
                    <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… *</label>
                    <input type="text" id="username" required placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ">
                </div>
                <div class="input-group">
                    <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ *</label>
                    <input type="email" id="email" required placeholder="name@example.com">
                </div>
                <div class="input-group">
                    <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Ù„Ù„ØªØ´ÙÙŠØ± Ø§Ù„Ù…Ø­Ù„ÙŠ)</label>
                    <input type="password" id="password" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ">
                </div>
                <button type="submit" class="btn btn-primary w-full">Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…</button>
            </form>
            <div class="mt-4 p-4" style="background: var(--bg-body); border-radius: var(--radius-md);">
                <p class="text-sm text-light mb-2"><i class="fas fa-info-circle"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:</p>
                <input type="file" id="import-file" accept=".json" onchange="actions.importData()" style="font-size: 0.8rem;">
            </div>
            <p class="text-center text-sm text-light mt-4">Â© 2024 ER1991. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.</p>
        </div>
    </div>

    <!-- App Screen -->
    <div id="app-screen" class="hidden">
        <aside id="sidebar">
            <div class="nav-brand">ER1991 <span>Wallet</span></div>
            
            <div class="nav-section">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
            <nav>
                <div class="nav-item active" onclick="router.navigate('dashboard')">
                    <i class="fas fa-chart-pie"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
                </div>
                <div class="nav-item" onclick="router.navigate('wallet')">
                    <i class="fas fa-wallet"></i> Ø§Ù„Ù…Ø­ÙØ¸Ø© (Ø¯Ø®Ù„/Ù…ØµØ±ÙˆÙ)
                </div>
                
                <div class="nav-section">Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±Ø§Øª</div>
                <div class="nav-item" onclick="router.navigate('trading')">
                    <i class="fas fa-chart-line"></i> Ø§Ù„ØªØ¯Ø§ÙˆÙ„ (Ø£Ø³Ù‡Ù…)
                </div>
                <div class="nav-item" onclick="router.navigate('gold')">
                    <i class="fas fa-coins"></i> Ø§Ù„Ø°Ù‡Ø¨
                </div>
                <div class="nav-item" onclick="router.navigate('portfolio')">
                    <i class="fas fa-university"></i> Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±
                </div>
                
                <div class="nav-section">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
                <div class="nav-item" onclick="router.navigate('reports')">
                    <i class="fas fa-file-export"></i> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„ØªØµØ¯ÙŠØ±
                </div>
            </nav>

            <div class="user-mini-profile">
                <div class="user-name" id="sidebar-username">User</div>
                <div class="user-email" id="sidebar-email" style="font-size: 0.8rem; opacity: 0.7">email@example.com</div>
                <div class="mt-2 text-xs" id="sync-status" style="color: var(--accent-emerald)">
                    <i class="fas fa-check-circle"></i> Ù…ØªØ²Ø§Ù…Ù†
                </div>
                <button onclick="actions.logout()" class="btn btn-sm btn-outline mt-4 w-full" style="border-color: rgba(255,255,255,0.2); color: white;">
                    <i class="fas fa-sign-out-alt"></i> Ø®Ø±ÙˆØ¬
                </button>
            </div>
        </aside>

        <main>
            <header>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <button class="btn btn-outline" style="display: none;" id="mobile-menu-btn" onclick="document.getElementById('sidebar').classList.toggle('open')">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h2 id="page-title">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-outline btn-sm" onclick="actions.syncNow()" title="Ù…Ø²Ø§Ù…Ù†Ø© Ø³Ø­Ø§Ø¨ÙŠØ©">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="btn btn-outline btn-sm" onclick="actions.toggleTheme()">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </header>

            <!-- VIEW: Dashboard -->
            <section id="view-dashboard">
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <p class="text-light text-sm">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø®Ù„ (EGP)</p>
                        <div class="kpi-value text-emerald" id="dash-income-egp">0</div>
                    </div>
                    <div class="kpi-card">
                        <p class="text-light text-sm">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª (EGP)</p>
                        <div class="kpi-value text-danger" id="dash-expense-egp">0</div>
                    </div>
                    <div class="kpi-card">
                        <p class="text-light text-sm">Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø­ÙØ¸Ø© (EGP)</p>
                        <div class="kpi-value" id="dash-balance-egp">0</div>
                    </div>
                    <div class="kpi-card">
                        <p class="text-light text-sm">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£Ø³Ù‡Ù…</p>
                        <div class="kpi-value text-info" id="dash-stocks-value">0</div>
                    </div>
                    <div class="kpi-card">
                        <p class="text-light text-sm">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø°Ù‡Ø¨</p>
                        <div class="kpi-value text-warning" id="dash-gold-value">0</div>
                    </div>
                    <div class="kpi-card">
                        <p class="text-light text-sm">Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ø§Ù„ÙƒÙ„ÙŠ</p>
                        <div class="kpi-value" id="dash-total-return">0%</div>
                    </div>
                </div>

                <div class="dashboard-grid">
                    <div class="dashboard-card col-6">
                        <h3 class="mb-4"><i class="fas fa-chart-pie text-emerald"></i> ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£ØµÙˆÙ„</h3>
                        <div style="height: 300px; position: relative;">
                            <canvas id="assetsChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="dashboard-card col-6">
                        <h3 class="mb-4"><i class="fas fa-chart-bar text-emerald"></i> Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙØ¸</h3>
                        <div style="height: 300px; position: relative;">
                            <canvas id="performanceChart"></canvas>
                        </div>
                    </div>

                    <div class="dashboard-card col-6">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3><i class="fas fa-list text-emerald"></i> Ø¢Ø®Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
                            <button class="btn btn-sm btn-outline" onclick="router.navigate('wallet')">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</button>
                        </div>
                        <div class="table-container">
                            <table id="dash-recent-table">
                                <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ØªØµÙ†ÙŠÙ</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="dashboard-card col-6">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3><i class="fas fa-arrow-trend-up text-emerald"></i> Ø£ÙƒØ¨Ø± Ø§Ù„Ù…Ø±Ø§ÙƒØ² (Ø£Ø³Ù‡Ù…)</h3>
                            <button class="btn btn-sm btn-outline" onclick="router.navigate('trading')">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</button>
                        </div>
                        <div class="table-container">
                            <table id="dash-top-stocks">
                                <thead><tr><th>Ø§Ù„Ø³Ù‡Ù…</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th><th>Ø§Ù„Ø¹Ø§Ø¦Ø¯</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- VIEW: Wallet -->
            <section id="view-wallet" class="hidden">
                <div class="content-tabs">
                    <div class="content-tab active-tab" onclick="wallet.switchTab('stats')">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</div>
                    <div class="content-tab" onclick="wallet.switchTab('add')">Ø¹Ù…Ù„ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</div>
                    <div class="content-tab" onclick="wallet.switchTab('data')">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>
                </div>

                <div id="wallet-tab-stats">
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                        <button class="btn btn-sm btn-outline active-curr" onclick="wallet.setCurrency('EGP')">EGP</button>
                        <button class="btn btn-sm btn-outline" onclick="wallet.setCurrency('SAR')">SAR</button>
                        <button class="btn btn-sm btn-outline" onclick="wallet.setCurrency('USD')">USD</button>
                    </div>
                    
                    <div class="kpi-grid">
                        <div class="kpi-card">
                            <p class="text-light text-sm">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø®Ù„</p>
                            <div class="kpi-value text-emerald" id="wallet-income">0</div>
                        </div>
                        <div class="kpi-card">
                            <p class="text-light text-sm">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</p>
                            <div class="kpi-value text-danger" id="wallet-expense">0</div>
                        </div>
                        <div class="kpi-card">
                            <p class="text-light text-sm">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
                            <div class="kpi-value" id="wallet-balance">0</div>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="mb-4">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©</h3>
                        <div style="height: 300px;">
                            <canvas id="expenseChart"></canvas>
                        </div>
                    </div>
                </div>

                <div id="wallet-tab-add" class="hidden">
                    <div class="card" style="max-width: 800px; margin: 0 auto;">
                        <h3 class="mb-4">Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</h3>
                        <form id="transaction-form">
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                <div class="input-group" style="flex: 1; min-width: 200px;">
                                    <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© *</label>
                                    <select id="t-type" onchange="wallet.toggleCategories()" required>
                                        <option value="expense">Ù…ØµØ±ÙˆÙ (Expense)</option>
                                        <option value="income">Ø¯Ø®Ù„ (Income)</option>
                                    </select>
                                </div>
                                <div class="input-group" style="flex: 1; min-width: 200px;">
                                    <label>Ø§Ù„Ù…Ø¨Ù„Øº *</label>
                                    <input type="number" id="t-amount" step="0.01" required>
                                </div>
                            </div>

                            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                <div class="input-group" style="flex: 1; min-width: 200px;">
                                    <label>Ø§Ù„Ø¹Ù…Ù„Ø© *</label>
                                    <select id="t-currency" required>
                                        <option value="EGP">EGP (Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ)</option>
                                        <option value="SAR">SAR (Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ)</option>
                                        <option value="USD">USD (Ø¯ÙˆÙ„Ø§Ø± Ø£Ù…Ø±ÙŠÙƒÙŠ)</option>
                                    </select>
                                </div>
                                <div class="input-group" style="flex: 1; min-width: 200px;">
                                    <label>Ø§Ù„ØªØ§Ø±ÙŠØ® *</label>
                                    <input type="date" id="t-date" required>
                                </div>
                            </div>

                            <div class="input-group" id="expense-cats-group">
                                <label>Ø§Ù„ØªØµÙ†ÙŠÙ *</label>
                                <select id="t-category-exp">
                                    <option value="Ø·Ø¹Ø§Ù… ÙˆÙ…Ø´Ø±ÙˆØ¨Ø§Øª">ğŸ” Ø·Ø¹Ø§Ù… ÙˆÙ…Ø´Ø±ÙˆØ¨Ø§Øª</option>
                                    <option value="Ù…ÙˆØ§ØµÙ„Ø§Øª">ğŸš• Ù…ÙˆØ§ØµÙ„Ø§Øª</option>
                                    <option value="ØªØ³ÙˆÙ‚">ğŸ›’ ØªØ³ÙˆÙ‚</option>
                                    <option value="ÙÙˆØ§ØªÙŠØ±">ğŸ  ÙÙˆØ§ØªÙŠØ±</option>
                                    <option value="ØµØ­Ø©">ğŸ’Š ØµØ­Ø©</option>
                                    <option value="ØªØ¹Ù„ÙŠÙ…">ğŸ“š ØªØ¹Ù„ÙŠÙ…</option>
                                    <option value="ØªØ±ÙÙŠÙ‡">ğŸ‰ ØªØ±ÙÙŠÙ‡</option>
                                    <option value="Ø§ØªØµØ§Ù„Ø§Øª">ğŸ“± Ø§ØªØµØ§Ù„Ø§Øª</option>
                                    <option value="Ø§Ø³ØªØ«Ù…Ø§Ø±">ğŸ“ˆ Ø§Ø³ØªØ«Ù…Ø§Ø±</option>
                                    <option value="Ø£Ø®Ø±Ù‰">ğŸ§¾ Ø£Ø®Ø±Ù‰</option>
                                </select>
                            </div>

                            <div class="input-group hidden" id="income-cats-group">
                                <label>Ù…ØµØ¯Ø± Ø§Ù„Ø¯Ø®Ù„ *</label>
                                <select id="t-category-inc">
                                    <option value="Ø±Ø§ØªØ¨">ğŸ’¼ Ø±Ø§ØªØ¨</option>
                                    <option value="Ù…ÙƒØ§ÙØ£Ø©">ğŸ Ù…ÙƒØ§ÙØ£Ø©</option>
                                    <option value="Ø¹Ø§Ø¦Ø¯ Ø§Ø³ØªØ«Ù…Ø§Ø±">ğŸ“ˆ Ø¹Ø§Ø¦Ø¯ Ø§Ø³ØªØ«Ù…Ø§Ø±</option>
                                    <option value="Ø£Ø®Ø±Ù‰">ğŸ§¾ Ø£Ø®Ø±Ù‰</option>
                                </select>
                            </div>

                            <div class="input-group">
                                <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ *</label>
                                <select id="t-method" required>
                                    <option value="ÙƒØ§Ø´">ğŸ’µ ÙƒØ§Ø´</option>
                                    <option value="Instapay">ğŸ“± Instapay</option>
                                    <option value="ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ">ğŸ¦ ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</option>
                                    <option value="Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†">ğŸ’³ Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†</option>
                                    <option value="Ù…Ø­ÙØ¸Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©">ğŸ“² Ù…Ø­ÙØ¸Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</option>
                                </select>
                            </div>

                            <div class="input-group">
                                <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                                <textarea id="t-notes" rows="2"></textarea>
                            </div>

                            <button type="submit" class="btn btn-primary w-full">Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</button>
                        </form>
                    </div>
                </div>

                <div id="wallet-tab-data" class="hidden">
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3>Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="text" id="wallet-search" placeholder="Ø¨Ø­Ø«..." onkeyup="wallet.renderTable()" style="padding: 0.5rem; width: 200px;">
                                <button class="btn btn-accent btn-sm" onclick="reports.exportWallet()">
                                    <i class="fas fa-download"></i> Excel
                                </button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table id="wallet-table">
                                <thead>
                                    <tr>
                                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                        <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                        <th>Ø§Ù„ØªØµÙ†ÙŠÙ</th>
                                        <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                        <th>Ø§Ù„Ø¹Ù…Ù„Ø©</th>
                                        <th>Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©</th>
                                        <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- VIEW: Trading -->
            <section id="view-trading" class="hidden">
                <div class="content-tabs">
                    <div class="content-tab active-tab" onclick="trading.switchTab('portfolio')">Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø£Ø³Ù‡Ù…</div>
                    <div class="content-tab" onclick="trading.switchTab('add')">Ø¹Ù…Ù„ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</div>
                    <div class="content-tab" onclick="trading.switchTab('data')">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>
                    <div class="content-tab" onclick="trading.switchTab('dividends')">ØªÙˆØ²ÙŠØ¹Ø§Øª Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</div>
                </div>

                <div id="trading-tab-portfolio">
                    <div class="card mb-4">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3>Ù…Ù„Ø®Øµ Ù…Ø­ÙØ¸Ø© Ø§Ù„ØªØ¯Ø§ÙˆÙ„</h3>
                            <button class="btn btn-accent btn-sm" onclick="reports.exportStocksData()">
                                <i class="fas fa-download"></i> Excel
                            </button>
                        </div>
                        <div class="kpi-grid">
                            <div class="kpi-card">
                                <p class="text-light text-sm">Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</p>
                                <div class="kpi-value" id="trading-capital">0</div>
                            </div>
                            <div class="kpi-card">
                                <p class="text-light text-sm">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø±Ø§Ø¡</p>
                                <div class="kpi-value" id="trading-total-buy">0</div>
                            </div>
                            <div class="kpi-card">
                                <p class="text-light text-sm">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨ÙŠØ¹</p>
                                <div class="kpi-value" id="trading-total-sell">0</div>
                            </div>
                            <div class="kpi-card">
                                <p class="text-light text-sm">Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø©</p>
                                <div class="kpi-value" id="trading-pl">0</div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="mb-4">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©</h3>
                        <div class="table-container">
                            <table id="stocks-data-table">
                                <thead>
                                    <tr>
                                        <th>Ø§Ù„Ø³Ù‡Ù…</th>
                                        <th>Ø¢Ø®Ø± Ø´Ø±Ø§Ø¡</th>
                                        <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø±Ø§Ø¡</th>
                                        <th>Ù…ØªÙˆØ³Ø· Ø§Ù„Ø³Ø¹Ø±</th>
                                        <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨ÙŠØ¹</th>
                                        <th>Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</th>
                                        <th>Ø§Ù„Ø±ØµÙŠØ¯</th>
                                        <th>Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="trading-tab-add" class="hidden">
                    <div class="card" style="max-width: 900px; margin: 0 auto;">
                        <h3 class="mb-4">Ø·Ù„Ø¨ ØªØ¯Ø§ÙˆÙ„ Ø¬Ø¯ÙŠØ¯</h3>
                        <form id="trading-form">
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                <div class="input-group" style="flex: 1; min-width: 200px;">
                                    <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© *</label>
                                    <select id="st-type" required>
                                        <option value="buy">Ø´Ø±Ø§Ø¡ (Buy)</option>
                                        <option value="sell">Ø¨ÙŠØ¹ (Sell)</option>
                                    </select>
                                </div>
                                <div class="input-group" style="flex: 1; min-width: 200px;">
                                    <label>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ© *</label>
                                    <input type="text" id="st-name" list="stock-list" required placeholder="Ù…Ø«Ø§Ù„: Apple">
                                    <datalist id="stock-list"></datalist>
                                </div>
                            </div>

                            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                <div class="input-group" style="flex: 1; min-width: 200px;">
                                    <label>Ø§Ù„ØªØ§Ø±ÙŠØ® *</label>
                                    <input type="date" id="st-date" required>
                                </div>
                                <div class="input-group" style="flex: 1; min-width: 200px;">
                                    <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ù‡Ù… *</label>
                                    <input type="number" id="st-qty" step="0.01" required oninput="trading.calculateTotals()">
                                </div>
                            </div>

                            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                <div class="input-group" style="flex: 1; min-width: 200px;">
                                    <label>Ø³Ø¹Ø± Ø§Ù„Ø³Ù‡Ù… *</label>
                                    <input type="number" id="st-price" step="0.01" required oninput="trading.calculateTotals()">
                                </div>
                                <div class="input-group" style="flex: 1; min-width: 200px;">
                                    <label>Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©</label>
                                    <input type="number" id="st-comm" step="0.01" value="0" oninput="trading.calculateTotals()">
                                </div>
                            </div>

                            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                <div class="input-group" style="flex: 1; min-width: 200px;">
                                    <label>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø¯ÙˆÙ† Ø¹Ù…ÙˆÙ„Ø©</label>
                                    <input type="number" id="st-total-no-comm" step="0.01" readonly style="background: var(--bg-body);">
                                </div>
                                <div class="input-group" style="flex: 1; min-width: 200px;">
                                    <label>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¹ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© *</label>
                                    <input type="number" id="st-total" step="0.01" required oninput="trading.calculateReverse()">
                                </div>
                            </div>

                            <div class="input-group">
                                <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                                <textarea id="st-notes" rows="2"></textarea>
                            </div>

                            <button type="submit" class="btn btn-primary w-full">ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</button>
                        </form>
                    </div>
                </div>

                <div id="trading-tab-data" class="hidden">
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3>Ø³Ø¬Ù„ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ¯Ø§ÙˆÙ„</h3>
                            <button class="btn btn-accent btn-sm" onclick="reports.exportTradingLog()">
                                <i class="fas fa-download"></i> Excel
                            </button>
                        </div>
                        <div class="table-container">
                            <table id="trading-log-table">
                                <thead>
                                    <tr>
                                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                        <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                        <th>Ø§Ù„Ø´Ø±ÙƒØ©</th>
                                        <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                        <th>Ø§Ù„Ø³Ø¹Ø±</th>
                                        <th>Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©</th>
                                        <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                        <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="trading-tab-dividends" class="hidden">
                    <div class="card mb-4">
                        <h3 class="mb-4">Ø¥Ø¶Ø§ÙØ© ØªÙˆØ²ÙŠØ¹Ø§Øª Ø£Ø±Ø¨Ø§Ø­</h3>
                        <form id="dividend-form">
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                <div class="input-group" style="flex: 1; min-width: 200px;">
                                    <label>Ù†ÙˆØ¹ Ø§Ù„ØªÙˆØ²ÙŠØ¹ *</label>
                                    <select id="div-type" onchange="trading.toggleDivInputs()" required>
                                        <option value="cash">Ù…Ø¨Ù„Øº Ù†Ù‚Ø¯ÙŠ</option>
                                        <option value="shares">Ø£Ø³Ù‡Ù… Ù…ÙˆØ²Ø¹Ø©</option>
                                    </select>
                                </div>
                                <div class="input-group" style="flex: 1; min-width: 200px;">
                                    <label>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ© *</label>
                                    <input type="text" id="div-name" list="stock-list-div" required>
                                    <datalist id="stock-list-div"></datalist>
                                </div>
                            </div>

                            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                <div class="input-group" style="flex: 1; min-width: 200px;">
                                    <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
                                    <input type="date" id="div-date">
                                </div>
                                <div class="input-group" style="flex: 1; min-width: 200px;" id="div-amount-group">
                                    <label>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ *</label>
                                    <input type="number" id="div-amount" step="0.01">
                                </div>
                                <div class="input-group hidden" style="flex: 1; min-width: 200px;" id="div-shares-group">
                                    <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„Ù…ÙˆØ²Ø¹Ø© *</label>
                                    <input type="number" id="div-shares" step="0.01">
                                </div>
                            </div>

                            <div class="input-group" id="div-comm-group">
                                <label>Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©</label>
                                <input type="number" id="div-comm" step="0.01" value="0">
                            </div>

                            <button type="submit" class="btn btn-primary w-full">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª</button>
                        </form>
                    </div>

                    <div class="card">
                        <h3>Ø³Ø¬Ù„ Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª</h3>
                        <div class="table-container mt-4">
                            <table id="dividends-table">
                                <thead>
                                    <tr>
                                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                        <th>Ø§Ù„Ø´Ø±ÙƒØ©</th>
                                        <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                        <th>Ø§Ù„Ù‚ÙŠÙ…Ø©/Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                        <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- VIEW: Gold -->
            <section id="view-gold" class="hidden">
                <div class="content-tabs">
                    <div class="content-tab active-tab" onclick="gold.switchTab('portfolio')">Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø°Ù‡Ø¨</div>
                    <div class="content-tab" onclick="gold.switchTab('add')">Ø¹Ù…Ù„ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</div>
                    <div class="content-tab" onclick="gold.switchTab('data')">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>
                </div>

                <div id="gold-tab-portfolio">
                    <div class="card mb-4">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3>Ù…Ù„Ø®Øµ Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø°Ù‡Ø¨</h3>
                            <button class="btn btn-accent btn-sm" onclick="reports.exportGoldData()">
                                <i class="fas fa-download"></i> Excel
                            </button>
                        </div>
                        <div class="kpi-grid">
                            <div class="kpi-card">
                                <p class="text-light text-sm">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø±Ø§Ø¡</p>
                                <div class="kpi-value" id="gold-total-buy">0</div>
                            </div>
                            <div class="kpi-card">
                                <p class="text-light text-sm">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨ÙŠØ¹</p>
                                <div class="kpi-value" id="gold-total-sell">0</div>
                            </div>
                            <div class="kpi-card">
                                <p class="text-light text-sm">Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø©</p>
                                <div class="kpi-value" id="gold-pl">0</div>
                            </div>
                            <div class="kpi-card">
                                <p class="text-light text-sm">Ø§Ù„Ø¬Ø±Ø§Ù…Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</p>
                                <div class="kpi-value text-emerald" id="gold-remaining-grams">0</div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="mb-4">ØªÙØ§ØµÙŠÙ„ holdings Ø§Ù„Ø°Ù‡Ø¨</h3>
                        <div class="table-container">
                            <table id="gold-data-table">
                                <thead>
                                    <tr>
                                        <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                        <th>Ø§Ù„Ø¹ÙŠØ§Ø±</th>
                                        <th>Ø§Ù„Ø¬Ø±Ø§Ù…Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</th>
                                        <th>Ù…ØªÙˆØ³Ø· Ø§Ù„Ø³Ø¹Ø±/Ø¬Ø±Ø§Ù…</th>
                                        <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ©</th>
                                        <th>Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="gold-tab-add" class="hidden">
                    <div class="card" style="max-width: 800px; margin: 0 auto;">
                        <h3 class="mb-4">ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø°Ù‡Ø¨</h3>
                        <form id="gold-form">
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                <div class="input-group" style="flex: 1; min-width: 200px;">
                                    <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© *</label>
                                    <select id="gd-type" required>
                                        <option value="buy">Ø´Ø±Ø§Ø¡</option>
                                        <option value="sell">Ø¨ÙŠØ¹</option>
                                    </select>
                                </div>
                                <div class="input-group" style="flex: 1; min-width: 200px;">
                                    <label>Ø§Ù„Ù†ÙˆØ¹ (Ø³Ø¨Ø§Ø¦Ùƒ/Ù…Ø´ØºÙˆÙ„Ø§Øª/Ø¹Ù…Ù„Ø§Øª) *</label>
                                    <input type="text" id="gd-item" required placeholder="Ù…Ø«Ø§Ù„: Ø³Ø¨Ø§Ø¦Ùƒ 24">
                                </div>
                            </div>

                            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                <div class="input-group" style="flex: 1; min-width: 200px;">
                                    <label>Ø§Ù„Ø¹ÙŠØ§Ø± *</label>
                                    <select id="gd-karat" required>
                                        <option value="24">24</option>
                                        <option value="21">21</option>
                                        <option value="18">18</option>
                                    </select>
                                </div>
                                <div class="input-group" style="flex: 1; min-width: 200px;">
                                    <label>Ø§Ù„ÙˆØ²Ù† (Ø¬Ø±Ø§Ù…) *</label>
                                    <input type="number" id="gd-grams" step="0.01" required oninput="gold.calculateTotal()">
                                </div>
                            </div>

                            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                <div class="input-group" style="flex: 1; min-width: 200px;">
                                    <label>Ø³Ø¹Ø± Ø§Ù„Ø¬Ø±Ø§Ù… *</label>
                                    <input type="number" id="gd-price" step="0.01" required oninput="gold.calculateTotal()">
                                </div>
                                <div class="input-group" style="flex: 1; min-width: 200px;">
                                    <label>Ø§Ù„Ù…ØµÙ†Ø¹ÙŠØ© / Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©</label>
                                    <input type="number" id="gd-fees" step="0.01" value="0" oninput="gold.calculateTotal()">
                                </div>
                            </div>

                            <div class="input-group">
                                <label>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø´Ø§Ù…Ù„ Ø§Ù„Ù…ØµÙ†Ø¹ÙŠØ©</label>
                                <input type="number" id="gd-total" step="0.01" readonly style="background: var(--bg-body); font-weight: bold;">
                            </div>

                            <button type="submit" class="btn btn-primary w-full">Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</button>
                        </form>
                    </div>
                </div>

                <div id="gold-tab-data" class="hidden">
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3>Ø³Ø¬Ù„ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø°Ù‡Ø¨</h3>
                            <button class="btn btn-accent btn-sm" onclick="reports.exportGoldLog()">
                                <i class="fas fa-download"></i> Excel
                            </button>
                        </div>
                        <div class="table-container">
                            <table id="gold-log-table">
                                <thead>
                                    <tr>
                                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                        <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                        <th>Ø§Ù„Ø¹Ù†ØµØ±</th>
                                        <th>Ø§Ù„Ø¹ÙŠØ§Ø±</th>
                                        <th>Ø§Ù„Ø¬Ø±Ø§Ù…Ø§Øª</th>
                                        <th>Ø§Ù„Ø³Ø¹Ø±</th>
                                        <th>Ø§Ù„Ù…ØµÙ†Ø¹ÙŠØ©</th>
                                        <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- VIEW: Portfolio -->
            <section id="view-portfolio" class="hidden">
                <div class="content-tabs">
                    <div class="content-tab active-tab" onclick="portfolio.switchTab('summary')">Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø­Ø§ÙØ¸</div>
                    <div class="content-tab" onclick="portfolio.switchTab('add')">Ø¥ÙŠØ¯Ø§Ø¹/Ø³Ø­Ø¨</div>
                    <div class="content-tab" onclick="portfolio.switchTab('data')">Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª</div>
                </div>

                <div id="portfolio-tab-summary">
                    <div class="card mb-4">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø§ÙØ¸ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ©</h3>
                            <button class="btn btn-accent btn-sm" onclick="reports.exportPortfolioData()">
                                <i class="fas fa-download"></i> Excel
                            </button>
                        </div>
                        <div class="table-container">
                            <table id="portfolio-data-table">
                                <thead>
                                    <tr>
                                        <th>Ø§Ù„Ù…Ø­ÙØ¸Ø©</th>
                                        <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹</th>
                                        <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø­Ø¨</th>
                                        <th>Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª</th>
                                        <th>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ØµØ§ÙÙŠ</th>
                                        <th>Ø¢Ø®Ø± Ø¥ÙŠØ¯Ø§Ø¹</th>
                                        <th>Ø¢Ø®Ø± Ø³Ø­Ø¨</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="mb-4">Ù…Ù„Ø®Øµ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±Ø§Øª Ø§Ù„ÙƒÙ„ÙŠ</h3>
                        <div class="kpi-grid">
                            <div class="kpi-card">
                                <p class="text-light text-sm">Ø±Ø£Ø³ Ø§Ù„Ù…Ø§Ù„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</p>
                                <div class="kpi-value" id="inv-capital">0</div>
                            </div>
                            <div class="kpi-card">
                                <p class="text-light text-sm">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø±Ø§Ø¡</p>
                                <div class="kpi-value" id="inv-total-buy">0</div>
                            </div>
                            <div class="kpi-card">
                                <p class="text-light text-sm">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨ÙŠØ¹</p>
                                <div class="kpi-value" id="inv-total-sell">0</div>
                            </div>
                            <div class="kpi-card">
                                <p class="text-light text-sm">Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ø§Ù„ÙƒÙ„ÙŠ</p>
                                <div class="kpi-value" id="inv-total-pl">0</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="portfolio-tab-add" class="hidden">
                    <div class="card" style="max-width: 600px; margin: 0 auto;">
                        <h3 class="mb-4">Ø¥ÙŠØ¯Ø§Ø¹ / Ø³Ø­Ø¨ Ù…Ù† Ù…Ø­ÙØ¸Ø©</h3>
                        <form id="portfolio-form">
                            <div class="input-group">
                                <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø© *</label>
                                <select id="pf-name" required>
                                    <option value="Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø£Ø³Ù‡Ù…">Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø£Ø³Ù‡Ù…</option>
                                    <option value="Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø°Ù‡Ø¨">Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø°Ù‡Ø¨</option>
                                    <option value="Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¨Ù†ÙƒÙŠØ©">Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¨Ù†ÙƒÙŠØ©</option>
                                </select>
                            </div>

                            <div class="input-group">
                                <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© *</label>
                                <select id="pf-type" required>
                                    <option value="deposit">Ø¥ÙŠØ¯Ø§Ø¹ (+)</option>
                                    <option value="withdraw">Ø³Ø­Ø¨ (-)</option>
                                </select>
                            </div>

                            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                <div class="input-group" style="flex: 1; min-width: 200px;">
                                    <label>Ø§Ù„Ù…Ø¨Ù„Øº *</label>
                                    <input type="number" id="pf-amount" step="0.01" required>
                                </div>
                                <div class="input-group" style="flex: 1; min-width: 200px;">
                                    <label>Ø§Ù„ØªØ§Ø±ÙŠØ® *</label>
                                    <input type="date" id="pf-date" required>
                                </div>
                            </div>

                            <div class="input-group">
                                <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„</label>
                                <select id="pf-method">
                                    <option value="ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ">ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</option>
                                    <option value="Ø§Ù†Ø³ØªØ§Ø¨Ø§ÙŠ">Ø§Ù†Ø³ØªØ§Ø¨Ø§ÙŠ</option>
                                    <option value="ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´">ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´</option>
                                    <option value="Ù†Ù‚Ø¯ÙŠ">Ù†Ù‚Ø¯ÙŠ</option>
                                </select>
                            </div>

                            <div class="input-group">
                                <label>Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©</label>
                                <input type="number" id="pf-comm" step="0.01" value="0">
                            </div>

                            <div class="input-group">
                                <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                                <textarea id="pf-notes" rows="2"></textarea>
                            </div>

                            <button type="submit" class="btn btn-primary w-full">ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</button>
                        </form>
                    </div>
                </div>

                <div id="portfolio-tab-data" class="hidden">
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3>Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø­Ø§ÙØ¸</h3>
                            <button class="btn btn-accent btn-sm" onclick="reports.exportPortfolioLog()">
                                <i class="fas fa-download"></i> Excel
                            </button>
                        </div>
                        <div class="table-container">
                            <table id="portfolio-log-table">
                                <thead>
                                    <tr>
                                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                        <th>Ø§Ù„Ù…Ø­ÙØ¸Ø©</th>
                                        <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                        <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                        <th>Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©</th>
                                        <th>Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- VIEW: Reports -->
            <section id="view-reports" class="hidden">
                <div class="dashboard-grid">
                    <div class="dashboard-card col-6" style="text-align: center; padding: 3rem;">
                        <i class="fas fa-file-excel fa-3x text-emerald mb-4"></i>
                        <h3>ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙØ¸Ø©</h3>
                        <p class="text-light mb-4">ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¯Ø®Ù„ ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª</p>
                        <button onclick="reports.exportWallet()" class="btn btn-primary w-full">
                            <i class="fas fa-download"></i> ØªØ­Ù…ÙŠÙ„ Excel
                        </button>
                    </div>

                    <div class="dashboard-card col-6" style="text-align: center; padding: 3rem;">
                        <i class="fas fa-chart-line fa-3x text-emerald mb-4"></i>
                        <h3>ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±Ø§Øª</h3>
                        <p class="text-light mb-4">ØªØµØ¯ÙŠØ± Ø§Ù„Ø£Ø³Ù‡Ù… ÙˆØ§Ù„Ø°Ù‡Ø¨ ÙˆØ§Ù„Ù…Ø­Ø§ÙØ¸</p>
                        <button onclick="reports.exportAllInvestments()" class="btn btn-primary w-full">
                            <i class="fas fa-download"></i> ØªØ­Ù…ÙŠÙ„ Excel
                        </button>
                    </div>

                    <div class="dashboard-card col-6" style="text-align: center; padding: 3rem;">
                        <i class="fas fa-camera fa-3x text-emerald mb-4"></i>
                        <h3>Ø­ÙØ¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h3>
                        <p class="text-light mb-4">Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙƒØµÙˆØ±Ø© PNG</p>
                        <button onclick="reports.captureDashboard()" class="btn btn-accent w-full">
                            <i class="fas fa-camera"></i> Ø­ÙØ¸ ÙƒØµÙˆØ±Ø©
                        </button>
                    </div>

                    <div class="dashboard-card col-6" style="text-align: center; padding: 3rem;">
                        <i class="fas fa-database fa-3x text-emerald mb-4"></i>
                        <h3>Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙƒØ§Ù…Ù„</h3>
                        <p class="text-light mb-4">ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ…Ù„Ù JSON Ù„Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù„Ø§Ø­Ù‚Ø§Ù‹</p>
                        <button onclick="reports.exportBackup()" class="btn btn-primary w-full">
                            <i class="fas fa-download"></i> Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ
                        </button>
                    </div>
                </div>
            </section>

            <div class="app-footer">
                <p>Â© 2024 ER1991 Wallet. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.</p>
                <p class="text-sm mt-2">ØªÙ… Ø§Ù„ØªØ·ÙˆÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© <span class="text-emerald">ER1991</span> | Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„</p>
            </div>
        </main>
    </div>

    <div id="toast-container"></div>
    <button class="fab" onclick="actions.openQuickAdd()"><i class="fas fa-plus"></i></button>
    <script>
        // ==================== FIREBASE CONFIGURATION ====================
        // Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙŠÙ… Ø¨Ù‚ÙŠÙ… Ù…Ø´Ø±ÙˆØ¹Ùƒ ÙÙŠ Firebase
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "your-project.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };
        
        // Initialize Firebase (optional - Ù„Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ)
        let db = null;
        let auth = null;
        try {
            if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                console.log("Firebase initialized");
            }
        } catch (e) {
            console.log("Firebase not configured, using LocalStorage only");
        }

        // ==================== STATE MANAGEMENT (STORE) ====================
        const store = {
            state: {
                user: null,
                theme: 'light',
                activeCurrency: 'EGP',
                lastSync: null,
                
                // Raw Data (like Excel Request sheets)
                transactions: [],      // Wallet Request
                stocks: [],           // Trading Request
                dividends: [],        // Trading Request - Dividends
                gold: [],             // Gold Request
                portfolio: [],        // Portfolio Request
                
                // Calculated Data (like Excel Data sheets)
                stocksData: [],       // Stocks Data
                goldData: [],         // Gold Data
                portfolioData: []     // Portfolio Data
            },
            
            // Load data from LocalStorage
            load() {
                const saved = localStorage.getItem('ER1991_WALLET_DATA_v2');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        // Decrypt if password protected
                        if (parsed.encrypted && parsed.data) {
                            this.state = { ...this.state, ...parsed.data };
                        } else {
                            this.state = { ...this.state, ...parsed };
                        }
                    } catch (e) {
                        console.error("Error loading data:", e);
                    }
                }
                
                // Apply theme
                if (this.state.theme === 'dark') {
                    document.body.classList.add('dark-mode');
                }
                
                // Calculate all derived data
                this.calculateAll();
            },
            
            // Save to LocalStorage
            save() {
                // Recalculate before saving
                this.calculateAll();
                
                const dataToSave = {
                    ...this.state,
                    lastSave: new Date().toISOString()
                };
                
                // Encrypt if password exists
                if (this.state.user && this.state.user.password) {
                    localStorage.setItem('ER1991_WALLET_DATA_v2', JSON.stringify({
                        encrypted: true,
                        data: dataToSave
                    }));
                } else {
                    localStorage.setItem('ER1991_WALLET_DATA_v2', JSON.stringify(dataToSave));
                }
                
                // Sync to Firebase if available
                this.syncToCloud();
                
                // Update UI
                renderAll();
            },
            
            // Calculate all derived data (Excel formulas)
            calculateAll() {
                this.calculateStocksData();
                this.calculateGoldData();
                this.calculatePortfolioData();
            },
            
            // Calculate Stocks Data (like Excel Stocks Data sheet)
            calculateStocksData() {
                const portfolio = {};
                
                // Process all stock transactions
                this.state.stocks.forEach(st => {
                    if (!portfolio[st.name]) {
                        portfolio[st.name] = {
                            name: st.name,
                            totalBuyQty: 0,
                            totalBuyValue: 0,      // Column E
                            totalBuyComm: 0,       // Column F
                            lastBuyDate: null,     // Column B
                            totalSellQty: 0,
                            totalSellValue: 0,     // Column J
                            totalSellComm: 0,      // Column K
                            lastSellDate: null,    // Column G
                            dividendsCash: 0,      // Column L
                            dividendsShares: 0     // Column M
                        };
                    }
                    
                    const p = portfolio[st.name];
                    
                    if (st.type === 'buy') {
                        p.totalBuyQty += parseFloat(st.qty);
                        p.totalBuyValue += parseFloat(st.total);
                        p.totalBuyComm += parseFloat(st.comm || 0);
                        if (!p.lastBuyDate || st.date > p.lastBuyDate) {
                            p.lastBuyDate = st.date;
                        }
                    } else if (st.type === 'sell') {
                        p.totalSellQty += parseFloat(st.qty);
                        p.totalSellValue += parseFloat(st.total);
                        p.totalSellComm += parseFloat(st.comm || 0);
                        if (!p.lastSellDate || st.date > p.lastSellDate) {
                            p.lastSellDate = st.date;
                        }
                    }
                });
                
                // Process dividends
                this.state.dividends.forEach(div => {
                    if (!portfolio[div.name]) {
                        portfolio[div.name] = {
                            name: div.name,
                            totalBuyQty: 0, totalBuyValue: 0, totalBuyComm: 0, lastBuyDate: null,
                            totalSellQty: 0, totalSellValue: 0, totalSellComm: 0, lastSellDate: null,
                            dividendsCash: 0, dividendsShares: 0
                        };
                    }
                    if (div.type === 'cash') {
                        portfolio[div.name].dividendsCash += (parseFloat(div.amount) - parseFloat(div.comm || 0));
                    } else {
                        portfolio[div.name].dividendsShares += parseFloat(div.shares);
                    }
                });
                
                // Calculate derived values exactly like Excel
                this.state.stocksData = Object.values(portfolio).map(p => {
                    // Average buy price (Column D)
                    const avgBuyPrice = p.totalBuyQty > 0 ? p.totalBuyValue / p.totalBuyQty : 0;
                    
                    // Average sell price (Column I)
                    const avgSellPrice = p.totalSellQty > 0 ? p.totalSellValue / p.totalSellQty : 0;
                    
                    // Current holdings (Column P)
                    const currentQty = p.totalBuyQty - p.totalSellQty + p.dividendsShares;
                    
                    // P/L calculation (Column N)
                    // Excel formula: =IF(AND(J3<>"",E3<>"",C3<>0), J3 - ((E3 + L3 + (M3 * (H3 / C3)))), "")
                    let pl = 0;
                    if (p.totalSellValue > 0 && p.totalBuyValue > 0 && p.totalBuyQty > 0) {
                        const costBasis = p.totalBuyValue + p.dividendsCash + (p.dividendsShares * (p.totalSellQty / p.totalBuyQty));
                        pl = p.totalSellValue - costBasis;
                    }
                    
                    // Percentage (Column O)
                    const plPercent = (p.totalBuyValue + p.dividendsCash) > 0 ? 
                        (pl / (p.totalBuyValue + p.dividendsCash)) * 100 : 0;
                    
                    // Current price per share (Column Q)
                    const currentPrice = currentQty > 0 ? (p.totalBuyValue - p.totalSellValue) / currentQty : 0;
                    
                    // Current value (Column R)
                    const currentValue = currentQty * currentPrice;
                    
                    return {
                        ...p,
                        avgBuyPrice,
                        avgSellPrice,
                        currentQty,
                        currentPrice,
                        currentValue,
                        pl,
                        plPercent
                    };
                });
            },
            
            // Calculate Gold Data (like Excel Gold Data sheet)
            calculateGoldData() {
                const holdings = {};
                
                this.state.gold.forEach(g => {
                    const key = `${g.item}-${g.karat}`;
                    if (!holdings[key]) {
                        holdings[key] = {
                            item: g.item,
                            karat: g.karat,
                            totalGrams: 0,         // Column D
                            totalCost: 0,          // From price * grams
                            totalFees: 0,          // Column G
                            lastBuyDate: null,     // Column B
                            soldGrams: 0,          // Column J
                            soldValue: 0,          // Column L
                            lastSellDate: null     // Column H
                        };
                    }
                    
                    const h = holdings[key];
                    if (g.type === 'buy') {
                        h.totalGrams += parseFloat(g.grams);
                        h.totalCost += (parseFloat(g.grams) * parseFloat(g.price));
                        h.totalFees += parseFloat(g.fees || 0);
                        if (!h.lastBuyDate || g.date > h.lastBuyDate) {
                            h.lastBuyDate = g.date;
                        }
                    } else {
                        h.soldGrams += parseFloat(g.grams);
                        h.soldValue += (parseFloat(g.grams) * parseFloat(g.price));
                        if (!h.lastSellDate || g.date > h.lastSellDate) {
                            h.lastSellDate = g.date;
                        }
                    }
                });
                
                this.state.goldData = Object.values(holdings).map(h => {
                    const remainingGrams = h.totalGrams - h.soldGrams;  // Column P
                    const avgPrice = h.totalGrams > 0 ? (h.totalCost + h.totalFees) / h.totalGrams : 0;  // Column E & R
                    const currentValue = remainingGrams * avgPrice;  // Column S
                    const pl = h.soldValue - (h.totalCost + h.totalFees);  // Column N
                    const plPercent = (h.totalCost + h.totalFees) > 0 ? (pl / (h.totalCost + h.totalFees)) * 100 : 0;
                    
                    return {
                        ...h,
                        remainingGrams,
                        avgPrice,
                        currentValue,
                        pl,
                        plPercent
                    };
                });
            },
            
            // Calculate Portfolio Data (like Excel Portfolio Data sheet)
            calculatePortfolioData() {
                const portfolios = {};
                
                this.state.portfolio.forEach(p => {
                    if (!portfolios[p.name]) {
                        portfolios[p.name] = {
                            name: p.name,
                            totalDeposit: 0,       // Column B
                            totalWithdraw: 0,      // Column C
                            totalComm: 0,          // Column D
                            lastDeposit: null,     // Column F
                            lastWithdraw: null     // Column G
                        };
                    }
                    
                    const port = portfolios[p.name];
                    if (p.type === 'deposit') {
                        port.totalDeposit += parseFloat(p.amount);
                        port.totalComm += parseFloat(p.comm || 0);
                        if (!port.lastDeposit || p.date > port.lastDeposit) {
                            port.lastDeposit = p.date;
                        }
                    } else {
                        port.totalWithdraw += parseFloat(p.amount);
                        port.totalComm += parseFloat(p.comm || 0);
                        if (!port.lastWithdraw || p.date > port.lastWithdraw) {
                            port.lastWithdraw = p.date;
                        }
                    }
                });
                
                this.state.portfolioData = Object.values(portfolios).map(p => ({
                    ...p,
                    netBalance: p.totalDeposit - p.totalWithdraw - p.totalComm  // Column E
                }));
            },
            
            // Sync to Firebase (optional)
            async syncToCloud() {
                if (!db || !this.state.user) return;
                
                try {
                    await db.collection('users').doc(this.state.user.email).set({
                        data: this.state,
                        lastSync: new Date().toISOString()
                    });
                    this.state.lastSync = new Date().toISOString();
                    console.log("Synced to cloud");
                } catch (e) {
                    console.error("Sync failed:", e);
                }
            },
            
            // Load from Firebase
            async loadFromCloud() {
                if (!db || !this.state.user) return false;
                
                try {
                    const doc = await db.collection('users').doc(this.state.user.email).get();
                    if (doc.exists) {
                        const cloudData = doc.data().data;
                        if (cloudData && cloudData.lastSave > this.state.lastSave) {
                            this.state = { ...this.state, ...cloudData };
                            this.save();
                            return true;
                        }
                    }
                } catch (e) {
                    console.error("Load from cloud failed:", e);
                }
                return false;
            }
        };

        // ==================== HELPER FUNCTIONS ====================
        const $ = (id) => document.getElementById(id);
        
        const formatMoney = (amount, currency = 'EGP') => {
            if (amount === undefined || amount === null || isNaN(amount)) return '-';
            return new Intl.NumberFormat('ar-EG', { 
                style: 'currency', 
                currency: currency,
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        };
        
        const formatNumber = (num, decimals = 2) => {
            if (num === undefined || num === null || isNaN(num)) return '-';
            return new Intl.NumberFormat('ar-EG', { 
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            }).format(num);
        };
        
        const generateId = () => '_' + Math.random().toString(36).substr(2, 9);
        
        const showToast = (msg, type = 'success') => {
            const container = $('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icon = type === 'success' ? 'fa-check-circle' : 
                        type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';
            toast.innerHTML = `<i class="fas ${icon}"></i> <span>${msg}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        };
        
        const formatDate = (dateStr) => {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('ar-EG', { year: 'numeric', month: 'short', day: 'numeric' });
        };
        
        const formatDateTime = (dateStr) => {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleString('ar-EG');
        };

        // ==================== ACTIONS ====================
        const actions = {
            // Login
            login: (e) => {
                e.preventDefault();
                const name = $('username').value;
                const email = $('email').value;
                const password = $('password').value;
                
                store.state.user = { 
                    name, 
                    email,
                    password: password ? btoa(password) : null, // Simple encoding
                    loginTime: new Date().toISOString()
                };
                
                // Try to load from cloud first
                if (db) {
                    store.loadFromCloud().then(loaded => {
                        if (loaded) {
                            showToast('ØªÙ… Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©');
                        }
                        store.save();
                        router.init();
                    });
                } else {
                    store.save();
                    router.init();
                    showToast(`Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ ${name}`);
                }
            },
            
            // Logout
            logout: () => {
                if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
                    store.state.user = null;
                    localStorage.removeItem('ER1991_WALLET_DATA_v2');
                    location.reload();
                }
            },
            
            // Toggle Theme
            toggleTheme: () => {
                store.state.theme = store.state.theme === 'light' ? 'dark' : 'light';
                document.body.classList.toggle('dark-mode');
                store.save();
            },
            
            // Open Quick Add based on current view
            openQuickAdd: () => {
                const currentView = document.querySelector('section:not(.hidden)').id;
                switch(currentView) {
                    case 'view-wallet': wallet.switchTab('add'); break;
                    case 'view-trading': trading.switchTab('add'); break;
                    case 'view-gold': gold.switchTab('add'); break;
                    case 'view-portfolio': portfolio.switchTab('add'); break;
                    default: wallet.switchTab('add');
                }
            },
            
            // Manual sync
            syncNow: async () => {
                if (!db) {
                    showToast('Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ ØºÙŠØ± Ù…ÙØ¹Ù„', 'warning');
                    return;
                }
                $('sync-status').innerHTML = '<i class="fas fa-sync fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...';
                await store.syncToCloud();
                $('sync-status').innerHTML = '<i class="fas fa-check-circle"></i> Ù…ØªØ²Ø§Ù…Ù†';
                showToast('ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­');
            },
            
            // Import data from JSON file
            importData: (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (confirm('Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø³ÙŠØ³ØªØ¨Ø¯Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ')) {
                            store.state = { ...store.state, ...data };
                            store.save();
                            showToast('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
                            setTimeout(() => location.reload(), 1000);
                        }
                    } catch (err) {
                        showToast('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù', 'error');
                    }
                };
                reader.readAsText(file);
            }
        };

        // ==================== ROUTER ====================
        const router = {
            init: () => {
                $('splash-screen').classList.add('hidden');
                
                if (!store.state.user) {
                    $('auth-screen').classList.remove('hidden');
                } else {
                    $('app-screen').classList.remove('hidden');
                    $('sidebar-username').innerText = store.state.user.name;
                    $('sidebar-email').innerText = store.state.user.email;
                    
                    // Set default dates
                    const today = new Date().toISOString().split('T')[0];
                    ['t-date', 'st-date', 'pf-date', 'div-date'].forEach(id => {
                        if ($(id)) $(id).value = today;
                    });
                    
                    renderAll();
                }
            },
            
            navigate: (view) => {
                // Update sidebar
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                document.querySelector(`.nav-item[onclick*="${view}"]`).classList.add('active');
                
                // Update header title
                const titles = {
                    'dashboard': 'Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…',
                    'wallet': 'Ø§Ù„Ù…Ø­ÙØ¸Ø©',
                    'trading': 'Ø§Ù„ØªØ¯Ø§ÙˆÙ„',
                    'gold': 'Ø§Ù„Ø°Ù‡Ø¨',
                    'portfolio': 'Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±',
                    'reports': 'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±'
                };
                $('page-title').innerText = titles[view];
                
                // Toggle views
                ['dashboard', 'wallet', 'trading', 'gold', 'portfolio', 'reports'].forEach(v => {
                    $(`view-${v}`).classList.add('hidden');
                });
                $(`view-${view}`).classList.remove('hidden');
                
                // Render specific view
                switch(view) {
                    case 'dashboard': dashboard.render(); break;
                    case 'wallet': wallet.render(); break;
                    case 'trading': trading.render(); break;
                    case 'gold': gold.render(); break;
                    case 'portfolio': portfolio.render(); break;
                }
                
                // Close mobile menu
                $('sidebar').classList.remove('open');
                
                // Show/hide FAB
                const showFab = ['wallet', 'trading', 'gold', 'portfolio'].includes(view);
                $('fab-btn').style.display = showFab ? 'flex' : 'none';
            }
        };
<!-- PART 3: END --><!-- PART 4: START -->
        // ==================== DASHBOARD MODULE ====================
        const dashboard = {
            charts: {},
            
            render: () => {
                // Calculate all stats
                const walletStats = dashboard.calculateWalletStats();
                const investStats = dashboard.calculateInvestmentStats();
                
                // Update KPI cards
                $('dash-income-egp').innerText = formatMoney(walletStats.incomeEGP, 'EGP');
                $('dash-expense-egp').innerText = formatMoney(walletStats.expenseEGP, 'EGP');
                $('dash-balance-egp').innerText = formatMoney(walletStats.balanceEGP, 'EGP');
                
                $('dash-stocks-value').innerText = formatMoney(investStats.stocksValue);
                $('dash-gold-value').innerText = formatMoney(investStats.goldValue);
                
                const totalReturn = parseFloat(investStats.totalReturn);
                $('dash-total-return').innerText = totalReturn + '%';
                $('dash-total-return').className = totalReturn >= 0 ? 'kpi-value text-emerald' : 'kpi-value text-danger';
                
                // Render tables
                dashboard.renderRecentTransactions();
                dashboard.renderTopStocks();
                
                // Render charts
                dashboard.renderCharts(walletStats, investStats);
            },
            
            calculateWalletStats: () => {
                const txs = store.state.transactions;
                const incomeEGP = txs.filter(t => t.type === 'income' && t.currency === 'EGP')
                    .reduce((sum, t) => sum + parseFloat(t.amount), 0);
                const expenseEGP = txs.filter(t => t.type === 'expense' && t.currency === 'EGP')
                    .reduce((sum, t) => sum + parseFloat(t.amount), 0);
                
                return {
                    incomeEGP,
                    expenseEGP,
                    balanceEGP: incomeEGP - expenseEGP,
                    incomeSAR: txs.filter(t => t.type === 'income' && t.currency === 'SAR')
                        .reduce((sum, t) => sum + parseFloat(t.amount), 0),
                    expenseSAR: txs.filter(t => t.type === 'expense' && t.currency === 'SAR')
                        .reduce((sum, t) => sum + parseFloat(t.amount), 0),
                    incomeUSD: txs.filter(t => t.type === 'income' && t.currency === 'USD')
                        .reduce((sum, t) => sum + parseFloat(t.amount), 0),
                    expenseUSD: txs.filter(t => t.type === 'expense' && t.currency === 'USD')
                        .reduce((sum, t) => sum + parseFloat(t.amount), 0)
                };
            },
            
            calculateInvestmentStats: () => {
                const stocksValue = store.state.stocksData.reduce((sum, s) => sum + (s.currentValue || 0), 0);
                const goldValue = store.state.goldData.reduce((sum, g) => sum + (g.currentValue || 0), 0);
                
                const totalCost = store.state.stocksData.reduce((sum, s) => sum + (s.totalBuyValue || 0), 0) +
                                 store.state.goldData.reduce((sum, g) => sum + ((g.totalCost || 0) + (g.totalFees || 0)), 0);
                const totalValue = stocksValue + goldValue;
                const totalReturn = totalCost > 0 ? ((totalValue - totalCost) / totalCost * 100).toFixed(2) : 0;
                
                return {
                    stocksValue,
                    goldValue,
                    totalValue,
                    totalReturn
                };
            },
            
            renderRecentTransactions: () => {
                const tbody = $('dash-recent-table').querySelector('tbody');
                tbody.innerHTML = '';
                
                const recent = store.state.transactions.slice(0, 5);
                recent.forEach(t => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${formatDate(t.date)}</td>
                        <td><span class="status-badge ${t.type === 'income' ? 'status-income' : 'status-expense'}">${t.type === 'income' ? 'Ø¯Ø®Ù„' : 'Ù…ØµØ±ÙˆÙ'}</span></td>
                        <td>${t.category}</td>
                        <td style="font-weight: 600">${formatMoney(t.amount, t.currency)}</td>
                    `;
                    tbody.appendChild(tr);
                });
            },
            
            renderTopStocks: () => {
                const tbody = $('dash-top-stocks').querySelector('tbody');
                tbody.innerHTML = '';
                
                const topStocks = store.state.stocksData
                    .filter(s => s.currentQty > 0)
                    .sort((a, b) => b.currentValue - a.currentValue)
                    .slice(0, 5);
                
                topStocks.forEach(s => {
                    const returnPercent = s.plPercent || 0;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="font-weight: 600">${s.name}</td>
                        <td>${formatNumber(s.currentQty)}</td>
                        <td>${formatMoney(s.currentValue)}</td>
                        <td style="color: ${returnPercent >= 0 ? 'var(--accent-emerald)' : 'var(--danger)'}">${returnPercent.toFixed(2)}%</td>
                    `;
                    tbody.appendChild(tr);
                });
            },
            
            renderCharts: (walletStats, investStats) => {
                // Assets Distribution Chart
                const assetsCtx = $('assetsChart').getContext('2d');
                
                if (dashboard.charts.assets) dashboard.charts.assets.destroy();
                
                dashboard.charts.assets = new Chart(assetsCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©', 'Ø§Ù„Ø£Ø³Ù‡Ù…', 'Ø§Ù„Ø°Ù‡Ø¨'],
                        datasets: [{
                            data: [
                                walletStats.balanceEGP,
                                investStats.stocksValue,
                                investStats.goldValue
                            ],
                            backgroundColor: ['#3b82f6', '#10b981', '#f59e0b'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { font: { family: 'Tajawal', size: 12 } }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.label + ': ' + formatMoney(context.raw);
                                    }
                                }
                            }
                        }
                    }
                });
                
                // Performance Chart (Monthly comparison)
                const perfCtx = $('performanceChart').getContext('2d');
                
                if (dashboard.charts.performance) dashboard.charts.performance.destroy();
                
                // Group transactions by month
                const monthlyData = {};
                const months = ['ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ', 'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'];
                
                store.state.transactions.forEach(t => {
                    const date = new Date(t.date);
                    const monthKey = date.getMonth();
                    if (!monthlyData[monthKey]) monthlyData[monthKey] = { income: 0, expense: 0 };
                    if (t.type === 'income') monthlyData[monthKey].income += parseFloat(t.amount);
                    else monthlyData[monthKey].expense += parseFloat(t.amount);
                });
                
                const currentMonth = new Date().getMonth();
                const last6Months = [];
                const incomeData = [];
                const expenseData = [];
                
                for (let i = 5; i >= 0; i--) {
                    const monthIndex = (currentMonth - i + 12) % 12;
                    last6Months.push(months[monthIndex]);
                    incomeData.push(monthlyData[monthIndex]?.income || 0);
                    expenseData.push(monthlyData[monthIndex]?.expense || 0);
                }
                
                dashboard.charts.performance = new Chart(perfCtx, {
                    type: 'bar',
                    data: {
                        labels: last6Months,
                        datasets: [
                            {
                                label: 'Ø§Ù„Ø¯Ø®Ù„',
                                data: incomeData,
                                backgroundColor: '#10b981'
                            },
                            {
                                label: 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª',
                                data: expenseData,
                                backgroundColor: '#ef4444'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { font: { family: 'Tajawal' } }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatMoney(value, 'EGP').replace('Ø¬.Ù….', '');
                                    }
                                }
                            }
                        }
                    }
                });
            }
        };

        // ==================== WALLET MODULE ====================
        const wallet = {
            currentCurrency: 'EGP',
            
            switchTab: (tab) => {
                // Update tabs
                document.querySelectorAll('#view-wallet .content-tab').forEach(t => t.classList.remove('active-tab'));
                document.querySelector(`#view-wallet .content-tab[onclick*="'${tab}'"]`)?.classList.add('active-tab');
                
                // Show/hide content
                ['stats', 'add', 'data'].forEach(t => {
                    $(`wallet-tab-${t}`).classList.add('hidden');
                });
                $(`wallet-tab-${tab}`).classList.remove('hidden');
                
                if (tab === 'stats') wallet.renderStats();
                if (tab === 'data') wallet.renderTable();
            },
            
            setCurrency: (curr) => {
                wallet.currentCurrency = curr;
                
                // Update buttons
                document.querySelectorAll('#wallet-tab-stats .btn-sm').forEach(btn => {
                    btn.classList.remove('active-curr');
                    btn.style.background = '';
                    btn.style.color = '';
                });
                event.target.classList.add('active-curr');
                event.target.style.background = 'var(--accent-emerald)';
                event.target.style.color = 'white';
                
                wallet.renderStats();
            },
            
            render: () => {
                wallet.renderStats();
            },
            
            renderStats: () => {
                const curr = wallet.currentCurrency;
                const txs = store.state.transactions.filter(t => t.currency === curr);
                
                const income = txs.filter(t => t.type === 'income').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                const expense = txs.filter(t => t.type === 'expense').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                const balance = income - expense;
                
                $('wallet-income').innerText = formatMoney(income, curr);
                $('wallet-expense').innerText = formatMoney(expense, curr);
                $('wallet-balance').innerText = formatMoney(balance, curr);
                
                // Render expense categories chart
                wallet.renderExpenseChart(curr);
            },
            
            renderExpenseChart: (curr) => {
                const expenses = store.state.transactions.filter(t => 
                    t.type === 'expense' && t.currency === curr
                );
                
                const categories = {};
                expenses.forEach(e => {
                    categories[e.category] = (categories[e.category] || 0) + parseFloat(e.amount);
                });
                
                const ctx = $('expenseChart').getContext('2d');
                
                // Destroy existing chart
                if (wallet.expenseChart) wallet.expenseChart.destroy();
                
                wallet.expenseChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(categories),
                        datasets: [{
                            label: 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª',
                            data: Object.values(categories),
                            backgroundColor: '#ef4444'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatMoney(value, curr).replace(curr, '');
                                    }
                                }
                            }
                        }
                    }
                });
            },
            
            toggleCategories: () => {
                const type = $('t-type').value;
                $('expense-cats-group').classList.toggle('hidden', type !== 'expense');
                $('income-cats-group').classList.toggle('hidden', type !== 'income');
            },
            
            addTransaction: (e) => {
                e.preventDefault();
                
                const type = $('t-type').value;
                const category = type === 'expense' ? $('t-category-exp').value : $('t-category-inc').value;
                
                const tx = {
                    id: generateId(),
                    timestamp: new Date().toISOString(),
                    date: $('t-date').value,
                    amount: parseFloat($('t-amount').value),
                    currency: $('t-currency').value,
                    type: type,
                    category: category,
                    method: $('t-method').value,
                    notes: $('t-notes').value
                };
                
                store.state.transactions.unshift(tx);
                store.save();
                
                $('transaction-form').reset();
                $('t-date').value = new Date().toISOString().split('T')[0];
                
                showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');
                wallet.switchTab('stats');
            },
            
            deleteTransaction: (id) => {
                if (confirm('Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ')) {
                    store.state.transactions = store.state.transactions.filter(t => t.id !== id);
                    store.save();
                    wallet.renderTable();
                    showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù');
                }
            },
            
            renderTable: () => {
                const tbody = $('wallet-table').querySelector('tbody');
                tbody.innerHTML = '';
                
                const search = $('wallet-search').value.toLowerCase();
                const filtered = store.state.transactions.filter(t => 
                    t.category.toLowerCase().includes(search) ||
                    (t.notes && t.notes.toLowerCase().includes(search))
                );
                
                filtered.forEach(t => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${formatDate(t.date)}</td>
                        <td><span class="status-badge ${t.type === 'income' ? 'status-income' : 'status-expense'}">${t.type === 'income' ? 'Ø¯Ø®Ù„' : 'Ù…ØµØ±ÙˆÙ'}</span></td>
                        <td>${t.category}</td>
                        <td style="font-weight: 600">${formatMoney(t.amount, t.currency)}</td>
                        <td>${t.currency}</td>
                        <td>${t.method}</td>
                        <td><button onclick="wallet.deleteTransaction('${t.id}')" class="btn btn-sm btn-outline" style="color: var(--danger)"><i class="fas fa-trash"></i></button></td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        };

        // ==================== TRADING MODULE ====================
        const trading = {
            switchTab: (tab) => {
                document.querySelectorAll('#view-trading .content-tab').forEach(t => t.classList.remove('active-tab'));
                document.querySelector(`#view-trading .content-tab[onclick*="'${tab}'"]`)?.classList.add('active-tab');
                
                ['portfolio', 'add', 'data', 'dividends'].forEach(t => {
                    $(`trading-tab-${t}`).classList.add('hidden');
                });
                $(`trading-tab-${tab}`).classList.remove('hidden');
                
                if (tab === 'portfolio') trading.renderPortfolio();
                if (tab === 'data') trading.renderLog();
                if (tab === 'dividends') trading.renderDividends();
            },
            
            render: () => {
                trading.renderPortfolio();
                trading.updateStockLists();
            },
            
            updateStockLists: () => {
                const stocks = [...new Set(store.state.stocks.map(s => s.name))];
                const lists = ['stock-list', 'stock-list-div'];
                
                lists.forEach(listId => {
                    const dl = $(listId);
                    if (dl) {
                        dl.innerHTML = '';
                        stocks.forEach(s => {
                            const op = document.createElement('option');
                            op.value = s;
                            dl.appendChild(op);
                        });
                    }
                });
            },
            
            calculateTotals: () => {
                const qty = parseFloat($('st-qty').value) || 0;
                const price = parseFloat($('st-price').value) || 0;
                const comm = parseFloat($('st-comm').value) || 0;
                
                const totalNoComm = qty * price;
                const total = totalNoComm + comm;
                
                $('st-total-no-comm').value = totalNoComm.toFixed(2);
                $('st-total').value = total.toFixed(2);
            },
            
            calculateReverse: () => {
                const qty = parseFloat($('st-qty').value) || 0;
                const total = parseFloat($('st-total').value) || 0;
                const comm = parseFloat($('st-comm').value) || 0;
                
                if (qty > 0) {
                    const price = (total - comm) / qty;
                    $('st-price').value = price.toFixed(2);
                    $('st-total-no-comm').value = (total - comm).toFixed(2);
                }
            },
            
            addTransaction: (e) => {
                e.preventDefault();
                
                const st = {
                    id: generateId(),
                    timestamp: new Date().toISOString(),
                    type: $('st-type').value,
                    name: $('st-name').value,
                    date: $('st-date').value,
                    qty: parseFloat($('st-qty').value),
                    price: parseFloat($('st-price').value),
                    comm: parseFloat($('st-comm').value) || 0,
                    total: parseFloat($('st-total').value),
                    notes: $('st-notes').value
                };
                
                store.state.stocks.unshift(st);
                store.save();
                
                $('trading-form').reset();
                $('st-date').value = new Date().toISOString().split('T')[0];
                
                showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©');
                trading.updateStockLists();
                trading.switchTab('portfolio');
            },
            
            deleteTransaction: (id) => {
                if (confirm('Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ')) {
                    store.state.stocks = store.state.stocks.filter(s => s.id !== id);
                    store.save();
                    trading.renderLog();
                    trading.renderPortfolio();
                }
            },
            
            renderPortfolio: () => {
                // Update summary cards
                const capital = store.state.portfolioData.find(p => p.name === 'Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø£Ø³Ù‡Ù…')?.totalDeposit || 0;
                const totalBuy = store.state.stocksData.reduce((sum, s) => sum + (s.totalBuyValue || 0), 0);
                const totalSell = store.state.stocksData.reduce((sum, s) => sum + (s.totalSellValue || 0), 0);
                const pl = totalSell - totalBuy;
                
                $('trading-capital').innerText = formatMoney(capital);
                $('trading-total-buy').innerText = formatMoney(totalBuy);
                $('trading-total-sell').innerText = formatMoney(totalSell);
                $('trading-pl').innerText = formatMoney(pl);
                $('trading-pl').style.color = pl >= 0 ? 'var(--accent-emerald)' : 'var(--danger)';
                
                // Render stocks data table
                const tbody = $('stocks-data-table').querySelector('tbody');
                tbody.innerHTML = '';
                
                store.state.stocksData.forEach(s => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="font-weight: 600">${s.name}</td>
                        <td>${s.lastBuyDate ? formatDate(s.lastBuyDate) : '-'}</td>
                        <td>${formatMoney(s.totalBuyValue)}</td>
                        <td>${formatNumber(s.avgBuyPrice)}</td>
                        <td>${formatMoney(s.totalSellValue)}</td>
                        <td>${formatMoney(s.dividendsCash)}</td>
                        <td>${formatNumber(s.currentQty)}</td>
                        <td>${formatMoney(s.currentValue)}</td>
                    `;
                    tbody.appendChild(tr);
                });
            },
            
            renderLog: () => {
                const tbody = $('trading-log-table').querySelector('tbody');
                tbody.innerHTML = '';
                
                store.state.stocks.forEach(s => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${formatDate(s.date)}</td>
                        <td><span class="status-badge ${s.type === 'buy' ? 'status-buy' : 'status-sell'}">${s.type === 'buy' ? 'Ø´Ø±Ø§Ø¡' : 'Ø¨ÙŠØ¹'}</span></td>
                        <td>${s.name}</td>
                        <td>${formatNumber(s.qty)}</td>
                        <td>${formatNumber(s.price)}</td>
                        <td>${formatMoney(s.comm)}</td>
                        <td>${formatMoney(s.total)}</td>
                        <td><button onclick="trading.deleteTransaction('${s.id}')" class="btn btn-sm btn-outline" style="color: var(--danger)"><i class="fas fa-trash"></i></button></td>
                    `;
                    tbody.appendChild(tr);
                });
            },
            
            toggleDivInputs: () => {
                const type = $('div-type').value;
                const isCash = type === 'cash';
                
                $('div-amount-group').classList.toggle('hidden', !isCash);
                $('div-shares-group').classList.toggle('hidden', isCash);
                $('div-comm-group').classList.toggle('hidden', !isCash);
            },
            
            addDividend: (e) => {
                e.preventDefault();
                
                const div = {
                    id: generateId(),
                    timestamp: new Date().toISOString(),
                    type: $('div-type').value,
                    name: $('div-name').value,
                    date: $('div-date').value || new Date().toISOString().split('T')[0],
                    amount: $('div-type').value === 'cash' ? parseFloat($('div-amount').value) || 0 : 0,
                    shares: $('div-type').value === 'shares' ? parseFloat($('div-shares').value) || 0 : 0,
                    comm: parseFloat($('div-comm').value) || 0
                };
                
                store.state.dividends.unshift(div);
                store.save();
                
                $('dividend-form').reset();
                showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª');
                trading.renderDividends();
            },
            
            deleteDividend: (id) => {
                if (confirm('Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§ØªØŸ')) {
                    store.state.dividends = store.state.dividends.filter(d => d.id !== id);
                    store.save();
                    trading.renderDividends();
                }
            },
            
            renderDividends: () => {
                const tbody = $('dividends-table').querySelector('tbody');
                tbody.innerHTML = '';
                
                store.state.dividends.forEach(d => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${formatDate(d.date)}</td>
                        <td>${d.name}</td>
                        <td>${d.type === 'cash' ? 'Ù†Ù‚Ø¯ÙŠ' : 'Ø£Ø³Ù‡Ù…'}</td>
                        <td>${d.type === 'cash' ? formatMoney(d.amount) : formatNumber(d.shares)}</td>
                        <td><button onclick="trading.deleteDividend('${d.id}')" class="btn btn-sm btn-outline" style="color: var(--danger)"><i class="fas fa-trash"></i></button></td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        };
        // ==================== GOLD MODULE ====================
        const gold = {
            switchTab: (tab) => {
                document.querySelectorAll('#view-gold .content-tab').forEach(t => t.classList.remove('active-tab'));
                document.querySelector(`#view-gold .content-tab[onclick*="'${tab}'"]`)?.classList.add('active-tab');
                
                ['portfolio', 'add', 'data'].forEach(t => {
                    $(`gold-tab-${t}`).classList.add('hidden');
                });
                $(`gold-tab-${tab}`).classList.remove('hidden');
                
                if (tab === 'portfolio') gold.renderPortfolio();
                if (tab === 'data') gold.renderLog();
            },
            
            render: () => {
                gold.renderPortfolio();
            },
            
            calculateTotal: () => {
                const grams = parseFloat($('gd-grams').value) || 0;
                const price = parseFloat($('gd-price').value) || 0;
                const fees = parseFloat($('gd-fees').value) || 0;
                
                const total = (grams * price) + fees;
                $('gd-total').value = total.toFixed(2);
            },
            
            addTransaction: (e) => {
                e.preventDefault();
                
                const gd = {
                    id: generateId(),
                    timestamp: new Date().toISOString(),
                    type: $('gd-type').value,
                    item: $('gd-item').value,
                    karat: $('gd-karat').value,
                    grams: parseFloat($('gd-grams').value),
                    price: parseFloat($('gd-price').value),
                    fees: parseFloat($('gd-fees').value) || 0,
                    total: parseFloat($('gd-total').value),
                    date: new Date().toISOString().split('T')[0]
                };
                
                store.state.gold.unshift(gd);
                store.save();
                
                $('gold-form').reset();
                showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø°Ù‡Ø¨');
                gold.switchTab('portfolio');
            },
            
            deleteTransaction: (id) => {
                if (confirm('Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ')) {
                    store.state.gold = store.state.gold.filter(g => g.id !== id);
                    store.save();
                    gold.renderLog();
                    gold.renderPortfolio();
                }
            },
            
            renderPortfolio: () => {
                // Update summary
                const totalBuy = store.state.goldData.reduce((sum, g) => sum + ((g.totalCost || 0) + (g.totalFees || 0)), 0);
                const totalSell = store.state.goldData.reduce((sum, g) => sum + (g.soldValue || 0), 0);
                const pl = totalSell - totalBuy;
                const remainingGrams = store.state.goldData.reduce((sum, g) => sum + (g.remainingGrams || 0), 0);
                
                $('gold-total-buy').innerText = formatMoney(totalBuy);
                $('gold-total-sell').innerText = formatMoney(totalSell);
                $('gold-pl').innerText = formatMoney(pl);
                $('gold-pl').style.color = pl >= 0 ? 'var(--accent-emerald)' : 'var(--danger)';
                $('gold-remaining-grams').innerText = formatNumber(remainingGrams) + ' Ø¬Ø±Ø§Ù…';
                
                // Render table
                const tbody = $('gold-data-table').querySelector('tbody');
                tbody.innerHTML = '';
                
                store.state.goldData.forEach(g => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${g.item}</td>
                        <td>${g.karat}</td>
                        <td>${formatNumber(g.remainingGrams)}</td>
                        <td>${formatNumber(g.avgPrice)}</td>
                        <td>${formatMoney((g.totalCost || 0) + (g.totalFees || 0))}</td>
                        <td>${formatMoney(g.currentValue)}</td>
                    `;
                    tbody.appendChild(tr);
                });
            },
            
            renderLog: () => {
                const tbody = $('gold-log-table').querySelector('tbody');
                tbody.innerHTML = '';
                
                store.state.gold.forEach(g => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${formatDate(g.date)}</td>
                        <td><span class="status-badge ${g.type === 'buy' ? 'status-buy' : 'status-sell'}">${g.type === 'buy' ? 'Ø´Ø±Ø§Ø¡' : 'Ø¨ÙŠØ¹'}</span></td>
                        <td>${g.item}</td>
                        <td>${g.karat}</td>
                        <td>${formatNumber(g.grams)}</td>
                        <td>${formatNumber(g.price)}</td>
                        <td>${formatMoney(g.fees)}</td>
                        <td>${formatMoney(g.total)}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        };

        // ==================== PORTFOLIO MODULE ====================
        const portfolio = {
            switchTab: (tab) => {
                document.querySelectorAll('#view-portfolio .content-tab').forEach(t => t.classList.remove('active-tab'));
                document.querySelector(`#view-portfolio .content-tab[onclick*="'${tab}'"]`)?.classList.add('active-tab');
                
                ['summary', 'add', 'data'].forEach(t => {
                    $(`portfolio-tab-${t}`).classList.add('hidden');
                });
                $(`portfolio-tab-${tab}`).classList.remove('hidden');
                
                if (tab === 'summary') portfolio.renderSummary();
                if (tab === 'data') portfolio.renderLog();
            },
            
            render: () => {
                portfolio.renderSummary();
            },
            
            addTransaction: (e) => {
                e.preventDefault();
                
                const pf = {
                    id: generateId(),
                    timestamp: new Date().toISOString(),
                    name: $('pf-name').value,
                    type: $('pf-type').value,
                    amount: parseFloat($('pf-amount').value),
                    date: $('pf-date').value,
                    method: $('pf-method').value,
                    comm: parseFloat($('pf-comm').value) || 0,
                    notes: $('pf-notes').value
                };
                
                store.state.portfolio.unshift(pf);
                store.save();
                
                $('portfolio-form').reset();
                $('pf-date').value = new Date().toISOString().split('T')[0];
                
                showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­ÙØ¸Ø©');
                portfolio.switchTab('summary');
            },
            
            renderSummary: () => {
                // Portfolio data table
                const tbody = $('portfolio-data-table').querySelector('tbody');
                tbody.innerHTML = '';
                
                store.state.portfolioData.forEach(p => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="font-weight: 600">${p.name}</td>
                        <td style="color: var(--accent-emerald)">${formatMoney(p.totalDeposit)}</td>
                        <td style="color: var(--danger)">${formatMoney(p.totalWithdraw)}</td>
                        <td>${formatMoney(p.totalComm)}</td>
                        <td style="font-weight: 700">${formatMoney(p.netBalance)}</td>
                        <td>${p.lastDeposit ? formatDate(p.lastDeposit) : '-'}</td>
                        <td>${p.lastWithdraw ? formatDate(p.lastWithdraw) : '-'}</td>
                    `;
                    tbody.appendChild(tr);
                });
                
                // Investment summary (My Investments Data)
                const capital = store.state.portfolioData.reduce((sum, p) => sum + (p.totalDeposit || 0), 0);
                
                // Calculate totals based on Excel formulas
                const stocksBuy = store.state.stocksData.reduce((sum, s) => sum + (s.totalBuyValue || 0), 0);
                const goldBuy = store.state.goldData.reduce((sum, g) => sum + ((g.totalCost || 0) + (g.totalFees || 0)), 0);
                const totalBuy = stocksBuy + goldBuy;
                
                const stocksSell = store.state.stocksData.reduce((sum, s) => sum + (s.totalSellValue || 0), 0);
                const goldSell = store.state.goldData.reduce((sum, g) => sum + (g.soldValue || 0), 0);
                const totalSell = stocksSell + goldSell;
                
                const pl = totalSell - totalBuy;
                
                $('inv-capital').innerText = formatMoney(capital);
                $('inv-total-buy').innerText = formatMoney(totalBuy);
                $('inv-total-sell').innerText = formatMoney(totalSell);
                $('inv-total-pl').innerText = formatMoney(pl);
                $('inv-total-pl').style.color = pl >= 0 ? 'var(--accent-emerald)' : 'var(--danger)';
            },
            
            renderLog: () => {
                const tbody = $('portfolio-log-table').querySelector('tbody');
                tbody.innerHTML = '';
                
                store.state.portfolio.forEach(p => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${formatDate(p.date)}</td>
                        <td>${p.name}</td>
                        <td><span class="status-badge ${p.type === 'deposit' ? 'status-buy' : 'status-sell'}">${p.type === 'deposit' ? 'Ø¥ÙŠØ¯Ø§Ø¹' : 'Ø³Ø­Ø¨'}</span></td>
                        <td style="font-weight: 600">${formatMoney(p.amount)}</td>
                        <td>${p.method}</td>
                        <td>${p.comm > 0 ? formatMoney(p.comm) : '-'}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        };

        // ==================== REPORTS MODULE ====================
        const reports = {
            exportWallet: () => {
                const data = store.state.transactions.map(t => ({
                    'Ø§Ù„ØªØ§Ø±ÙŠØ®': t.date,
                    'Ø§Ù„ÙˆÙ‚Øª': new Date(t.timestamp).toLocaleTimeString('ar-EG'),
                    'Ø§Ù„Ù†ÙˆØ¹': t.type === 'income' ? 'Ø¯Ø®Ù„' : 'Ù…ØµØ±ÙˆÙ',
                    'Ø§Ù„ØªØµÙ†ÙŠÙ': t.category,
                    'Ø§Ù„Ù…Ø¨Ù„Øº': t.amount,
                    'Ø§Ù„Ø¹Ù…Ù„Ø©': t.currency,
                    'Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©': t.method,
                    'Ù…Ù„Ø§Ø­Ø¸Ø§Øª': t.notes || ''
                }));
                
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„Ù…Ø­ÙØ¸Ø©");
                
                // Set column widths
                ws['!cols'] = [
                    {wch: 12}, {wch: 10}, {wch: 10}, {wch: 20}, 
                    {wch: 12}, {wch: 8}, {wch: 15}, {wch: 30}
                ];
                
                XLSX.writeFile(wb, `ER1991_Wallet_${new Date().toISOString().split('T')[0]}.xlsx`);
                showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙØ¸Ø©');
            },
            
            exportAllInvestments: () => {
                const wb = XLSX.utils.book_new();
                
                // Stocks sheet
                const stocksData = store.state.stocks.map(s => ({
                    'Ø§Ù„ØªØ§Ø±ÙŠØ®': s.date,
                    'Ø§Ù„Ù†ÙˆØ¹': s.type === 'buy' ? 'Ø´Ø±Ø§Ø¡' : 'Ø¨ÙŠØ¹',
                    'Ø§Ù„Ø´Ø±ÙƒØ©': s.name,
                    'Ø§Ù„ÙƒÙ…ÙŠØ©': s.qty,
                    'Ø§Ù„Ø³Ø¹Ø±': s.price,
                    'Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©': s.comm,
                    'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ': s.total,
                    'Ù…Ù„Ø§Ø­Ø¸Ø§Øª': s.notes || ''
                }));
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(stocksData), "Ø§Ù„Ø£Ø³Ù‡Ù…");
                
                // Gold sheet
                const goldData = store.state.gold.map(g => ({
                    'Ø§Ù„ØªØ§Ø±ÙŠØ®': g.date,
                    'Ø§Ù„Ù†ÙˆØ¹': g.type === 'buy' ? 'Ø´Ø±Ø§Ø¡' : 'Ø¨ÙŠØ¹',
                    'Ø§Ù„Ø¹Ù†ØµØ±': g.item,
                    'Ø§Ù„Ø¹ÙŠØ§Ø±': g.karat,
                    'Ø§Ù„Ø¬Ø±Ø§Ù…Ø§Øª': g.grams,
                    'Ø³Ø¹Ø± Ø§Ù„Ø¬Ø±Ø§Ù…': g.price,
                    'Ø§Ù„Ù…ØµÙ†Ø¹ÙŠØ©': g.fees,
                    'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ': g.total
                }));
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(goldData), "Ø§Ù„Ø°Ù‡Ø¨");
                
                // Portfolio sheet
                const pfData = store.state.portfolio.map(p => ({
                    'Ø§Ù„ØªØ§Ø±ÙŠØ®': p.date,
                    'Ø§Ù„Ù…Ø­ÙØ¸Ø©': p.name,
                    'Ø§Ù„Ù†ÙˆØ¹': p.type === 'deposit' ? 'Ø¥ÙŠØ¯Ø§Ø¹' : 'Ø³Ø­Ø¨',
                    'Ø§Ù„Ù…Ø¨Ù„Øº': p.amount,
                    'Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©': p.method,
                    'Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©': p.comm,
                    'Ù…Ù„Ø§Ø­Ø¸Ø§Øª': p.notes || ''
                }));
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(pfData), "Ø§Ù„Ù…Ø­Ø§ÙØ¸");
                
                // Dividends sheet
                const divData = store.state.dividends.map(d => ({
                    'Ø§Ù„ØªØ§Ø±ÙŠØ®': d.date,
                    'Ø§Ù„Ø´Ø±ÙƒØ©': d.name,
                    'Ø§Ù„Ù†ÙˆØ¹': d.type === 'cash' ? 'Ù†Ù‚Ø¯ÙŠ' : 'Ø£Ø³Ù‡Ù…',
                    'Ø§Ù„Ù‚ÙŠÙ…Ø©': d.type === 'cash' ? d.amount : 0,
                    'Ø§Ù„ÙƒÙ…ÙŠØ©': d.type === 'shares' ? d.shares : 0,
                    'Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©': d.comm || 0
                }));
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(divData), "Ø§Ù„Ø£Ø±Ø¨Ø§Ø­");
                
                XLSX.writeFile(wb, `ER1991_Investments_${new Date().toISOString().split('T')[0]}.xlsx`);
                showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±Ø§Øª');
            },
            
            exportStocksData: () => {
                const data = store.state.stocksData.map(s => ({
                    'Ø§Ù„Ø³Ù‡Ù…': s.name,
                    'Ø¢Ø®Ø± Ø´Ø±Ø§Ø¡': s.lastBuyDate || '-',
                    'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø±Ø§Ø¡': s.totalBuyValue,
                    'Ù…ØªÙˆØ³Ø· Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡': s.avgBuyPrice,
                    'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨ÙŠØ¹': s.totalSellValue,
                    'Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©': s.dividendsCash,
                    'Ø§Ù„Ø£Ø³Ù‡Ù… Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©': s.dividendsShares,
                    'Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø©': s.pl,
                    'Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ø¨Ø­ %': s.plPercent,
                    'Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ': s.currentQty,
                    'Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙƒÙ„ÙØ©': s.currentPrice,
                    'Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©': s.currentValue
                }));
                
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ù‡Ù…");
                XLSX.writeFile(wb, `ER1991_Stocks_Data_${new Date().toISOString().split('T')[0]}.xlsx`);
                showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ù‡Ù…');
            },
            
            exportGoldData: () => {
                const data = store.state.goldData.map(g => ({
                    'Ø§Ù„Ù†ÙˆØ¹': g.item,
                    'Ø§Ù„Ø¹ÙŠØ§Ø±': g.karat,
                    'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø±Ø§Ø¡ (Ø¬Ø±Ø§Ù…)': g.totalGrams,
                    'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨ÙŠØ¹ (Ø¬Ø±Ø§Ù…)': g.soldGrams,
                    'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ (Ø¬Ø±Ø§Ù…)': g.remainingGrams,
                    'Ù…ØªÙˆØ³Ø· Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡': g.avgPrice,
                    'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ©': (g.totalCost || 0) + (g.totalFees || 0),
                    'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨ÙŠØ¹Ø§Øª': g.soldValue,
                    'Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø©': g.pl,
                    'Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©': g.currentValue
                }));
                
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø°Ù‡Ø¨");
                XLSX.writeFile(wb, `ER1991_Gold_Data_${new Date().toISOString().split('T')[0]}.xlsx`);
                showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø°Ù‡Ø¨');
            },
            
            exportPortfolioData: () => {
                const data = store.state.portfolioData.map(p => ({
                    'Ø§Ù„Ù…Ø­ÙØ¸Ø©': p.name,
                    'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹': p.totalDeposit,
                    'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø­Ø¨': p.totalWithdraw,
                    'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª': p.totalComm,
                    'Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ØµØ§ÙÙŠ': p.netBalance,
                    'Ø¢Ø®Ø± Ø¥ÙŠØ¯Ø§Ø¹': p.lastDeposit || '-',
                    'Ø¢Ø®Ø± Ø³Ø­Ø¨': p.lastWithdraw || '-'
                }));
                
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø§ÙØ¸");
                XLSX.writeFile(wb, `ER1991_Portfolio_Data_${new Date().toISOString().split('T')[0]}.xlsx`);
                showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø§ÙØ¸');
            },
            
            exportTradingLog: () => {
                reports.exportAllInvestments();
            },
            
            exportGoldLog: () => {
                reports.exportAllInvestments();
            },
            
            exportPortfolioLog: () => {
                reports.exportAllInvestments();
            },
            
            captureDashboard: () => {
                const element = $('view-dashboard');
                html2canvas(element, { scale: 2 }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `ER1991_Dashboard_${new Date().toISOString().split('T')[0]}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                    showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©');
                });
            },
            
            exportBackup: () => {
                const backupData = {
                    exportDate: new Date().toISOString(),
                    user: store.state.user?.email || 'unknown',
                    version: '2.0',
                    data: store.state
                };
                
                const dataStr = JSON.stringify(backupData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `ER1991_Backup_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
                showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©');
            }
        };

        // ==================== GLOBAL RENDER ====================
        function renderAll() {
            dashboard.render();
            wallet.render();
            trading.render();
            gold.render();
            portfolio.render();
        }

        // ==================== INITIALIZATION ====================
        window.onload = () => {
            // Load data
            store.load();
            
            // Setup event listeners
            $('login-form').addEventListener('submit', actions.login);
            $('transaction-form').addEventListener('submit', wallet.addTransaction);
            $('trading-form').addEventListener('submit', trading.addTransaction);
            $('dividend-form').addEventListener('submit', trading.addDividend);
            $('gold-form').addEventListener('submit', gold.addTransaction);
            $('portfolio-form').addEventListener('submit', portfolio.addTransaction);
            
            // Mobile menu button
            if (window.innerWidth <= 1024) {
                $('mobile-menu-btn').style.display = 'flex';
            }
            window.addEventListener('resize', () => {
                $('mobile-menu-btn').style.display = window.innerWidth <= 1024 ? 'flex' : 'none';
            });
            
            // Simulate loading
            let progress = 0;
            const loadingBar = $('loading-bar');
            const loadingInterval = setInterval(() => {
                progress += Math.random() * 30;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(loadingInterval);
                    setTimeout(() => {
                        router.init();
                    }, 500);
                }
                loadingBar.style.width = progress + '%';
            }, 200);
        };

        // Service Worker for offline support (optional)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(err => {
                console.log('Service Worker registration failed:', err);
            });
        }
    </script>
</body>
</html>
<!-- PART 5: END - COMPLETE -->
